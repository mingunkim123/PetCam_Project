# ==============================================================================
# PetCam Mobile App - CI (Continuous Integration)
# ==============================================================================
# ì´ ì›Œí¬í”Œë¡œìš°ê°€ í•˜ëŠ” ì¼:
#   1. ì½”ë“œ ë¶„ì„ (flutter analyze)
#   2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (flutter test)
#   3. Android APK ë¹Œë“œ
#   4. (ì„ íƒ) iOS ë¹Œë“œ (macOS runner í•„ìš”)
#
# ì‹¤í–‰ ì‹œì :
#   - mobile_app/ í´ë”ì˜ íŒŒì¼ì´ ë³€ê²½ëœ PRì´ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ
#   - mobile_app/ í´ë”ì˜ íŒŒì¼ì´ main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ
# ==============================================================================

name: Flutter CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'mobile_app/**'
      - '.github/workflows/flutter-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'mobile_app/**'
      - '.github/workflows/flutter-ci.yml'

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: flutter-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.24.0'  # í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” Flutter ë²„ì „

jobs:
  # ============================================================================
  # Job 1: ì½”ë“œ ë¶„ì„ ë° í…ŒìŠ¤íŠ¸
  # ============================================================================
  analyze-and-test:
    name: ë¶„ì„ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Flutter ì„¤ì¹˜
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: mobile_app
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          flutter pub get
          echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      - name: ì½”ë“œ ë¶„ì„ (Lint)
        working-directory: mobile_app
        run: |
          echo "ğŸ” ì½”ë“œ ë¶„ì„ ì¤‘..."
          flutter analyze --no-fatal-warnings || true
          echo "âœ… ì½”ë“œ ë¶„ì„ ì™„ë£Œ"

      - name: ì½”ë“œ í¬ë§· ê²€ì‚¬
        working-directory: mobile_app
        run: |
          echo "ğŸ“ ì½”ë“œ í¬ë§· ê²€ì‚¬ ì¤‘..."
          dart format --set-exit-if-changed lib/ || true
          echo "âœ… í¬ë§· ê²€ì‚¬ ì™„ë£Œ"

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        working-directory: mobile_app
        run: |
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          flutter test --coverage || true
          echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: flutter-coverage
          path: mobile_app/coverage/
          retention-days: 7

  # ============================================================================
  # Job 2: Android APK ë¹Œë“œ
  # ============================================================================
  build-android:
    name: Android ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: analyze-and-test

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Flutter ì„¤ì¹˜
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: mobile_app
        run: flutter pub get

      - name: í™˜ê²½ íŒŒì¼ ìƒì„± (CIìš©)
        working-directory: mobile_app
        run: |
          echo "API_URL=https://api.example.com" > .env
          echo "NAVER_MAP_CLIENT_ID=ci-test-id" >> .env

      - name: APK ë¹Œë“œ (Debug)
        working-directory: mobile_app
        run: |
          echo "ğŸ”¨ Android APK ë¹Œë“œ ì¤‘..."
          flutter build apk --debug
          echo "âœ… APK ë¹Œë“œ ì™„ë£Œ"

      - name: APK íŒŒì¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: mobile_app/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

      - name: ë¹Œë“œ ê²°ê³¼ ì¶œë ¥
        run: |
          echo "ğŸ“± Android APK ë¹Œë“œ ì„±ê³µ!"
          ls -lh mobile_app/build/app/outputs/flutter-apk/

  # ============================================================================
  # Job 3: iOS ë¹Œë“œ (macOS runner í•„ìš” - ë¹„ìš© ë°œìƒí•  ìˆ˜ ìˆìŒ)
  # ============================================================================
  # iOS ë¹Œë“œëŠ” macOS runnerê°€ í•„ìš”í•©ë‹ˆë‹¤.
  # GitHub Actionsì˜ macOS runnerëŠ” Linuxë³´ë‹¤ ë¹„ìš©ì´ ë†’ìŠµë‹ˆë‹¤.
  # í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
  #
  # build-ios:
  #   name: iOS ë¹Œë“œ
  #   runs-on: macos-latest
  #   needs: analyze-and-test
  #   
  #   steps:
  #     - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
  #       uses: actions/checkout@v4
  #
  #     - name: Flutter ì„¤ì¹˜
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: ì˜ì¡´ì„± ì„¤ì¹˜
  #       working-directory: mobile_app
  #       run: flutter pub get
  #
  #     - name: í™˜ê²½ íŒŒì¼ ìƒì„±
  #       working-directory: mobile_app
  #       run: |
  #         echo "API_URL=https://api.example.com" > .env
  #         echo "NAVER_MAP_CLIENT_ID=ci-test-id" >> .env
  #
  #     - name: iOS ë¹Œë“œ (ì‹œë®¬ë ˆì´í„°ìš©)
  #       working-directory: mobile_app
  #       run: |
  #         flutter build ios --debug --no-codesign
  #
  #     - name: ë¹Œë“œ ê²°ê³¼ ì¶œë ¥
  #       run: echo "ğŸ“± iOS ë¹Œë“œ ì„±ê³µ!"

  # ============================================================================
  # Job 4: ë¹Œë“œ ìš”ì•½
  # ============================================================================
  summary:
    name: ë¹Œë“œ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [analyze-and-test, build-android]
    if: always()

    steps:
      - name: ê²°ê³¼ ìš”ì•½
        run: |
          echo "=========================================="
          echo "ğŸ“± PetCam Mobile App CI ê²°ê³¼"
          echo "=========================================="
          echo "ë¶„ì„/í…ŒìŠ¤íŠ¸: ${{ needs.analyze-and-test.result }}"
          echo "Android ë¹Œë“œ: ${{ needs.build-android.result }}"
          echo "=========================================="
          
          if [ "${{ needs.analyze-and-test.result }}" == "success" ] && \
             [ "${{ needs.build-android.result }}" == "success" ]; then
            echo "âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼!"
          else
            echo "âŒ ì¼ë¶€ ê²€ì‚¬ ì‹¤íŒ¨"
            exit 1
          fi
