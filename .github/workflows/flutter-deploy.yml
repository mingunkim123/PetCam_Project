# ==============================================================================
# PetCam Mobile App - CD (Continuous Deployment)
# ==============================================================================
# ì´ ì›Œí¬í”Œë¡œìš°ê°€ í•˜ëŠ” ì¼:
#   1. Release APK/AAB ë¹Œë“œ (ì„œëª… í¬í•¨)
#   2. (ì„ íƒ) Google Play Store ë°°í¬
#   3. (ì„ íƒ) Apple App Store ë°°í¬
#
# ì‹¤í–‰ ì‹œì :
#   - ìˆ˜ë™ìœ¼ë¡œë§Œ ì‹¤í–‰ (workflow_dispatch)
#   - ë²„ì „ íƒœê·¸ ìƒì„± ì‹œ (ì˜ˆ: v1.0.0)
#
# í•„ìš”í•œ GitHub Secrets:
#   - KEYSTORE_BASE64: Android í‚¤ìŠ¤í† ì–´ íŒŒì¼ (Base64 ì¸ì½”ë”©)
#   - KEYSTORE_PASSWORD: í‚¤ìŠ¤í† ì–´ ë¹„ë°€ë²ˆí˜¸
#   - KEY_ALIAS: í‚¤ ë³„ì¹­
#   - KEY_PASSWORD: í‚¤ ë¹„ë°€ë²ˆí˜¸
#   - PLAY_STORE_CREDENTIALS: Google Play API JSON (ì„ íƒ)
#   - API_URL: í”„ë¡œë•ì…˜ API URL
#   - NAVER_MAP_CLIENT_ID: ë„¤ì´ë²„ ë§µ í´ë¼ì´ì–¸íŠ¸ ID
# ==============================================================================

name: Flutter Deploy

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ë¹Œë“œ íƒ€ì… ì„ íƒ'
        required: true
        default: 'apk'
        type: choice
        options:
          - apk      # APK íŒŒì¼ (í…ŒìŠ¤íŠ¸ìš©)
          - aab      # App Bundle (Play Storeìš©)
          - both     # ë‘˜ ë‹¤
      
      deploy_target:
        description: 'ë°°í¬ ëŒ€ìƒ'
        required: true
        default: 'none'
        type: choice
        options:
          - none          # ë¹Œë“œë§Œ (ë°°í¬ ì•ˆ í•¨)
          - internal      # ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™
          - production    # í”„ë¡œë•ì…˜ (ì£¼ì˜!)
      
      version_bump:
        description: 'ë²„ì „ ì¦ê°€'
        required: false
        default: 'patch'
        type: choice
        options:
          - none    # ë²„ì „ ë³€ê²½ ì•ˆ í•¨
          - patch   # 1.0.0 â†’ 1.0.1
          - minor   # 1.0.0 â†’ 1.1.0
          - major   # 1.0.0 â†’ 2.0.0

  # ë²„ì „ íƒœê·¸ ìƒì„± ì‹œ ìë™ ì‹¤í–‰
  push:
    tags:
      - 'v*.*.*'  # ì˜ˆ: v1.0.0, v1.2.3

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # ============================================================================
  # Job 1: Android Release ë¹Œë“œ
  # ============================================================================
  build-android-release:
    name: Android Release ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Flutter ì„¤ì¹˜
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: mobile_app
        run: flutter pub get

      # í”„ë¡œë•ì…˜ í™˜ê²½ íŒŒì¼ ìƒì„±
      - name: í™˜ê²½ íŒŒì¼ ìƒì„±
        working-directory: mobile_app
        run: |
          echo "API_URL=${{ secrets.API_URL }}" > .env
          echo "NAVER_MAP_CLIENT_ID=${{ secrets.NAVER_MAP_CLIENT_ID }}" >> .env

      # Android ì„œëª… í‚¤ ì„¤ì •
      - name: Android ì„œëª… í‚¤ ì„¤ì •
        if: env.KEYSTORE_EXISTS == 'true'
        env:
          KEYSTORE_EXISTS: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: mobile_app/android
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/upload-keystore.jks
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> key.properties
          echo "storeFile=upload-keystore.jks" >> key.properties

      # APK ë¹Œë“œ
      - name: APK ë¹Œë“œ (Release)
        if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == 'both' || github.event_name == 'push'
        working-directory: mobile_app
        run: |
          echo "ğŸ”¨ Release APK ë¹Œë“œ ì¤‘..."
          flutter build apk --release
          echo "âœ… APK ë¹Œë“œ ì™„ë£Œ"

      # AAB ë¹Œë“œ (Play Storeìš©)
      - name: AAB ë¹Œë“œ (Release)
        if: github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'both'
        working-directory: mobile_app
        run: |
          echo "ğŸ”¨ Release AAB ë¹Œë“œ ì¤‘..."
          flutter build appbundle --release
          echo "âœ… AAB ë¹Œë“œ ì™„ë£Œ"

      # APK ì—…ë¡œë“œ
      - name: APK íŒŒì¼ ì—…ë¡œë“œ
        if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == 'both' || github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release
          path: mobile_app/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      # AAB ì—…ë¡œë“œ
      - name: AAB íŒŒì¼ ì—…ë¡œë“œ
        if: github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-release
          path: mobile_app/build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: ë¹Œë“œ ê²°ê³¼ ì¶œë ¥
        run: |
          echo "=========================================="
          echo "ğŸ“± Android Release ë¹Œë“œ ì™„ë£Œ!"
          echo "=========================================="
          if [ -f mobile_app/build/app/outputs/flutter-apk/app-release.apk ]; then
            echo "APK: $(ls -lh mobile_app/build/app/outputs/flutter-apk/app-release.apk)"
          fi
          if [ -f mobile_app/build/app/outputs/bundle/release/app-release.aab ]; then
            echo "AAB: $(ls -lh mobile_app/build/app/outputs/bundle/release/app-release.aab)"
          fi

  # ============================================================================
  # Job 2: Google Play Store ë°°í¬ (ì„ íƒ)
  # ============================================================================
  deploy-play-store:
    name: Play Store ë°°í¬
    runs-on: ubuntu-latest
    needs: build-android-release
    # ìˆ˜ë™ ì‹¤í–‰ì´ê³ , ë°°í¬ ëŒ€ìƒì´ 'none'ì´ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.deploy_target != 'none' &&
      secrets.PLAY_STORE_CREDENTIALS != ''

    steps:
      - name: AAB íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: android-aab-release
          path: ./release

      - name: Play Store ë°°í¬
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_CREDENTIALS }}
          packageName: com.example.mobile_app  # TODO: ì‹¤ì œ íŒ¨í‚¤ì§€ëª…ìœ¼ë¡œ ë³€ê²½
          releaseFiles: ./release/app-release.aab
          track: ${{ github.event.inputs.deploy_target == 'production' && 'production' || 'internal' }}
          status: completed

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸš€ Google Play Store ë°°í¬ ì™„ë£Œ!"
          echo "íŠ¸ë™: ${{ github.event.inputs.deploy_target }}"

  # ============================================================================
  # Job 3: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
  # ============================================================================
  create-release:
    name: GitHub Release ìƒì„±
    runs-on: ubuntu-latest
    needs: build-android-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: APK ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: android-apk-release
          path: ./release

      - name: GitHub Release ìƒì„±
        uses: softprops/action-gh-release@v1
        with:
          files: ./release/app-release.apk
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ë¦´ë¦¬ì¦ˆ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ GitHub Release ìƒì„± ì™„ë£Œ!"
          echo "íƒœê·¸: ${{ github.ref_name }}"

  # ============================================================================
  # ë°°í¬ ìš”ì•½
  # ============================================================================
  summary:
    name: ë°°í¬ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [build-android-release]
    if: always()

    steps:
      - name: ê²°ê³¼ ìš”ì•½
        run: |
          echo "=========================================="
          echo "ğŸ“± PetCam Mobile App ë°°í¬ ê²°ê³¼"
          echo "=========================================="
          echo "ë¹Œë“œ íƒ€ì…: ${{ github.event.inputs.build_type || 'auto' }}"
          echo "ë°°í¬ ëŒ€ìƒ: ${{ github.event.inputs.deploy_target || 'release-only' }}"
          echo "Android ë¹Œë“œ: ${{ needs.build-android-release.result }}"
          echo "=========================================="
          
          if [ "${{ needs.build-android-release.result }}" == "success" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            echo ""
            echo "ğŸ“¥ APK ë‹¤ìš´ë¡œë“œ:"
            echo "   GitHub Actions â†’ Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
          fi
