# ==============================================================================
# PetCam AI Server - CI (Continuous Integration)
# ==============================================================================
# ì´ ì›Œí¬í”Œë¡œìš°ê°€ í•˜ëŠ” ì¼:
#   1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ë¦°íŠ¸)
#   2. ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
#   3. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„±
#
# ì‹¤í–‰ ì‹œì :
#   - ai_server/ í´ë”ì˜ íŒŒì¼ì´ ë³€ê²½ëœ PRì´ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ
#   - ai_server/ í´ë”ì˜ íŒŒì¼ì´ main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ
# ==============================================================================

name: Backend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'ai_server/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'ai_server/**'
      - '.github/workflows/backend-ci.yml'

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ê°™ì€ ë¸Œëœì¹˜ì—ì„œ ì—¬ëŸ¬ ì›Œí¬í”Œë¡œìš°ê°€ ë™ì‹œì— ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡)
concurrency:
  group: backend-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Job 1: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Lint)
  # ============================================================================
  lint:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì¹˜
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'ai_server/requirements.txt'

      - name: ë¦°íŠ¸ ë„êµ¬ ì„¤ì¹˜
        run: |
          pip install ruff

      - name: Ruff ë¦°íŠ¸ ê²€ì‚¬
        working-directory: ai_server
        run: |
          echo "ğŸ” ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ì¤‘..."
          ruff check . --output-format=github || true
          echo "âœ… ë¦°íŠ¸ ê²€ì‚¬ ì™„ë£Œ"

  # ============================================================================
  # Job 2: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  # ============================================================================
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: lint  # ë¦°íŠ¸ í†µê³¼ í›„ ì‹¤í–‰
    
    # í…ŒìŠ¤íŠ¸ìš© PostgreSQL ë°ì´í„°ë² ì´ìŠ¤
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        # ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì¹˜
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'ai_server/requirements.txt'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: ai_server
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        working-directory: ai_server
        env:
          DATABASE_URL: postgresql+asyncpg://testuser:testpassword@localhost:5432/testdb
          SECRET_KEY: test-secret-key-for-ci-only
          ALLOWED_ORIGINS: "*"
        run: |
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing || true
          echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: ai_server/coverage.xml
          retention-days: 7

  # ============================================================================
  # Job 3: Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸
  # ============================================================================
  docker-build:
    name: Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: test  # í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ ì‹¤í–‰
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ (í…ŒìŠ¤íŠ¸)
        uses: docker/build-push-action@v5
        with:
          context: ./ai_server
          push: false  # ë¹Œë“œë§Œ í•˜ê³  í‘¸ì‹œëŠ” ì•ˆ í•¨
          tags: petcam-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ë¹Œë“œ ì„±ê³µ ì•Œë¦¼
        run: |
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ!"
          echo "ì´ë¯¸ì§€: petcam-server:test"
