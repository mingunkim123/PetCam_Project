# ==============================================================================
# PetCam AI Server - CD (Continuous Deployment)
# ==============================================================================
# ì´ ì›Œí¬í”Œë¡œìš°ê°€ í•˜ëŠ” ì¼:
#   1. Docker ì´ë¯¸ì§€ ë¹Œë“œ
#   2. Docker Hub (ë˜ëŠ” GitHub Container Registry)ì— í‘¸ì‹œ
#   3. ì„œë²„ì— ë°°í¬ ì•Œë¦¼
#
# ì‹¤í–‰ ì‹œì :
#   - main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ (ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”)
#   - ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ë•Œ (workflow_dispatch)
#
# í•„ìš”í•œ GitHub Secrets:
#   - DOCKER_USERNAME: Docker Hub ì‚¬ìš©ìëª…
#   - DOCKER_PASSWORD: Docker Hub ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” Access Token
#   - DISCORD_WEBHOOK_URL: (ì„ íƒ) ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ìš©
# ==============================================================================

name: Backend Deploy

on:
  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ
  push:
    branches: [main]
    paths:
      - 'ai_server/**'
      - '.github/workflows/backend-deploy.yml'
  
  # ìˆ˜ë™ ì‹¤í–‰ (GitHub Actions íƒ­ì—ì„œ "Run workflow" ë²„íŠ¼)
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# ë™ì‹œ ë°°í¬ ë°©ì§€
concurrency:
  group: backend-deploy-${{ github.ref }}
  cancel-in-progress: false  # ë°°í¬ ì¤‘ì—ëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ

env:
  DOCKER_IMAGE: petcam-server
  REGISTRY: ghcr.io  # GitHub Container Registry ì‚¬ìš©

jobs:
  # ============================================================================
  # Job 1: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  # ============================================================================
  build-and-push:
    name: ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # GitHub Container Registry í‘¸ì‹œ ê¶Œí•œ
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ìƒì„±
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE }}
          tags: |
            # Git SHA (ì˜ˆ: sha-a1b2c3d)
            type=sha,prefix=sha-
            # ë¸Œëœì¹˜ëª… (ì˜ˆ: main)
            type=ref,event=branch
            # ë‚ ì§œ (ì˜ˆ: 20260127)
            type=raw,value={{date 'YYYYMMDD'}}
            # latest (main ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./ai_server
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # ë¹Œë“œ ì •ë³´ ì¶”ê°€
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}

      - name: ë¹Œë“œ ê²°ê³¼ ì¶œë ¥
        run: |
          echo "ğŸ“¦ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"
          echo "íƒœê·¸: ${{ steps.meta.outputs.tags }}"
          echo "ë‹¤ì´ì œìŠ¤íŠ¸: ${{ steps.build.outputs.digest }}"

  # ============================================================================
  # Job 2: ë°°í¬ ì•Œë¦¼
  # ============================================================================
  notify:
    name: ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ìƒê´€ì—†ì´ ì‹¤í–‰

    steps:
      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        run: |
          echo "=========================================="
          echo "ğŸš€ PetCam Backend ë°°í¬ ì™„ë£Œ"
          echo "=========================================="
          echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo "ì‘ì„±ì: ${{ github.actor }}"
          echo "ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
          
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "âœ… ìƒíƒœ: ì„±ê³µ"
            echo "ì´ë¯¸ì§€: ${{ needs.build-and-push.outputs.image_tag }}"
          else
            echo "âŒ ìƒíƒœ: ì‹¤íŒ¨"
          fi

      # Discord ì•Œë¦¼ (ì„ íƒì‚¬í•­ - DISCORD_WEBHOOK_URLì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
      - name: Discord ì•Œë¦¼ ì „ì†¡
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            STATUS="âœ… ì„±ê³µ"
            COLOR=3066993
          else
            STATUS="âŒ ì‹¤íŒ¨"
            COLOR=15158332
          fi
          
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸš€ PetCam Backend ë°°í¬\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"ìƒíƒœ\", \"value\": \"$STATUS\", \"inline\": true},
                  {\"name\": \"ë¸Œëœì¹˜\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                  {\"name\": \"ì»¤ë°‹\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": false}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"

  # ============================================================================
  # Job 3: ì„œë²„ ì—…ë°ì´íŠ¸ (Self-hosted runner ë˜ëŠ” SSH ì‚¬ìš© ì‹œ)
  # ============================================================================
  # ì´ Jobì€ ì‹¤ì œ ì„œë²„ê°€ ìˆì„ ë•Œ í™œì„±í™”í•©ë‹ˆë‹¤.
  # 
  # deploy-to-server:
  #   name: ì„œë²„ ë°°í¬
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: success()
  #   
  #   steps:
  #     - name: ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ë°°í¬
  #       uses: appleboy/ssh-action@v1.0.0
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USER }}
  #         key: ${{ secrets.SERVER_SSH_KEY }}
  #         script: |
  #           cd /app/petcam
  #           docker pull ${{ needs.build-and-push.outputs.image_tag }}
  #           docker-compose -f docker-compose.prod.yml up -d
