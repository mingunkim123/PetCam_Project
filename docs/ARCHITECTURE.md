# PetCam 시스템 아키텍처

## 개요

PetCam은 ESP32 기반 저전력 카메라, AI 백엔드 서버, 크로스 플랫폼 모바일 앱으로 구성된 **지능형 반려동물 모니터링 시스템**입니다.

## 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              PetCam System                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐         ┌──────────────┐         ┌──────────────────────┐ │
│  │              │  BLE    │              │  HTTP   │                      │ │
│  │   ESP32-CAM  │◄───────►│  Mobile App  │◄───────►│     AI Server        │ │
│  │   (Firmware) │         │  (Flutter)   │         │     (FastAPI)        │ │
│  │              │  WiFi   │              │         │                      │ │
│  └──────┬───────┘         └──────────────┘         └──────────┬───────────┘ │
│         │                                                      │             │
│         │ HTTP Upload                                          │             │
│         └──────────────────────────────────────────────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 컴포넌트별 상세

### 1. Firmware (ESP32-CAM)

**역할**: 저전력 이미지 캡처 및 전송

```
firmware/
├── src/
│   ├── main.cpp           # 메인 루프, Deep Sleep 관리
│   ├── camera_manager.cpp # 카메라 제어
│   └── ble_manager.cpp    # BLE 통신
├── include/
│   ├── main.h
│   └── ble_manager.h
└── platformio.ini         # PlatformIO 설정
```

**핵심 기능:**
- OV2640 카메라 모듈 제어
- Deep Sleep 모드로 배터리 최적화
- BLE를 통한 근거리 제어 (촬영 트리거, 설정 변경)
- WiFi를 통한 이미지 HTTP 업로드

**통신 프로토콜:**

| 방식 | 용도 | 상세 |
|------|------|------|
| BLE | 제어 | GATT 프로파일, 촬영 명령/응답 |
| HTTP | 업로드 | POST multipart/form-data |

---

### 2. Mobile App (Flutter)

**역할**: 사용자 인터페이스 및 디바이스 제어

```
mobile_app/lib/
├── main.dart                    # 앱 진입점
└── src/
    ├── core/                    # 공통 요소
    │   ├── constants/           # 상수, 스타일
    │   └── widgets/             # 공통 위젯
    │
    ├── features/                # Feature-First 구조
    │   ├── auth/                # 인증
    │   ├── home/                # 홈 (대시보드)
    │   ├── gallery/             # 갤러리
    │   ├── map/                 # 산책 지도
    │   └── store/               # 스토어
    │
    ├── routing/                 # GoRouter
    └── services/                # 서비스 레이어
        ├── auth_service.dart    # JWT 인증
        ├── ai_service.dart      # API 클라이언트
        └── ble_service.dart     # BLE 통신
```

**아키텍처 패턴:**

```
┌─────────────────────────────────────────────┐
│                Presentation                  │
│  (Screen, Widget, Controller)               │
├─────────────────────────────────────────────┤
│                  Domain                      │
│  (Model, Entity)                            │
├─────────────────────────────────────────────┤
│                   Data                       │
│  (Repository, DataSource)                   │
├─────────────────────────────────────────────┤
│                 Services                     │
│  (AuthService, BLEService, AIService)       │
└─────────────────────────────────────────────┘
```

**상태 관리**: Riverpod
- `StateNotifierProvider`: 복잡한 상태 (인증, 갤러리)
- `FutureProvider`: 비동기 데이터 로딩
- `StreamProvider`: 실시간 데이터 (BLE 스트림)

**라우팅**: GoRouter
- 선언적 라우팅
- Deep Link 지원
- 인증 상태에 따른 리다이렉트

---

### 3. AI Server (FastAPI)

**역할**: 이미지 처리, 데이터 저장, API 제공

```
ai_server/
├── main.py                      # FastAPI 앱
├── database.py                  # DB 연결
├── models.py                    # SQLAlchemy 모델
│
├── app/
│   ├── api/                     # REST API
│   │   ├── auth.py              # 인증 엔드포인트
│   │   ├── photos.py            # 사진 엔드포인트
│   │   └── health.py            # 헬스체크
│   │
│   ├── auth.py                  # JWT 로직
│   │
│   ├── core/
│   │   ├── config.py            # 설정 관리
│   │   ├── database.py          # 세션 관리
│   │   └── deps.py              # 의존성 주입
│   │
│   ├── models/                  # DB 모델
│   ├── schemas/                 # Pydantic 스키마
│   │
│   └── services/
│       └── ai_service.py        # AI 처리 로직
│
├── alembic/                     # DB 마이그레이션
├── storage/                     # 이미지 저장소
└── weights/                     # AI 모델 가중치
```

**레이어 구조:**

```
┌─────────────────────────────────────────────┐
│              API Layer (Routers)             │
│  auth.py, photos.py, health.py              │
├─────────────────────────────────────────────┤
│            Service Layer                     │
│  ai_service.py, image_service.py            │
├─────────────────────────────────────────────┤
│         Data Access Layer                    │
│  models/, database.py                        │
├─────────────────────────────────────────────┤
│              Database                        │
│  PostgreSQL                                  │
└─────────────────────────────────────────────┘
```

---

## 데이터 플로우

### 1. 이미지 업로드 및 처리

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ ESP32-CAM │────►│   App    │────►│  Server  │────►│    DB    │
│  촬영     │     │  선택    │     │  저장    │     │  메타    │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                                        │
                                        ▼
                                  ┌──────────┐
                                  │ AI 처리  │
                                  │ (백그라운드)
                                  └──────────┘
                                        │
                                        ▼
                                  ┌──────────┐
                                  │ 업스케일 │
                                  │ 이미지   │
                                  └──────────┘
```

**상세 단계:**

1. **ESP32-CAM**: 이미지 캡처
2. **Mobile App**: (선택) 베스트컷 선택 또는 직접 업로드
3. **Server**: 원본 이미지 저장, DB 레코드 생성 (status: queued)
4. **Background Task**: Real-ESRGAN으로 업스케일 처리
5. **Server**: 업스케일 이미지 저장, status 업데이트

### 2. 인증 플로우

```
┌────────────┐                              ┌────────────┐
│   Client   │                              │   Server   │
└─────┬──────┘                              └─────┬──────┘
      │                                           │
      │  POST /register                           │
      │  {username, password}                     │
      │──────────────────────────────────────────►│
      │                                           │
      │  200 {id, username, is_active}            │
      │◄──────────────────────────────────────────│
      │                                           │
      │  POST /token                              │
      │  (OAuth2 form)                            │
      │──────────────────────────────────────────►│
      │                                           │
      │  200 {access_token, token_type}           │
      │◄──────────────────────────────────────────│
      │                                           │
      │  GET /photos                              │
      │  Authorization: Bearer <token>            │
      │──────────────────────────────────────────►│
      │                                           │
      │  200 [photos...]                          │
      │◄──────────────────────────────────────────│
```

### 3. BLE 통신 플로우

```
┌────────────┐                              ┌────────────┐
│   Mobile   │                              │   ESP32    │
│    App     │                              │    CAM     │
└─────┬──────┘                              └─────┬──────┘
      │                                           │
      │  BLE Scan                                 │
      │──────────────────────────────────────────►│
      │                                           │
      │  Advertising (PetCam-XXXX)                │
      │◄──────────────────────────────────────────│
      │                                           │
      │  Connect                                  │
      │──────────────────────────────────────────►│
      │                                           │
      │  Discover Services                        │
      │◄─────────────────────────────────────────►│
      │                                           │
      │  Write Characteristic (촬영 명령)          │
      │──────────────────────────────────────────►│
      │                                           │
      │  Notify (촬영 완료/상태)                   │
      │◄──────────────────────────────────────────│
```

---

## 데이터베이스 스키마

### users

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| username | VARCHAR(50) | 사용자명 (unique) |
| hashed_password | VARCHAR(200) | bcrypt 해시 |
| is_active | BOOLEAN | 활성 상태 |

### photos

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| original_path | VARCHAR | 원본 이미지 경로 |
| upscaled_path | VARCHAR | 업스케일 이미지 경로 |
| status | ENUM | queued/processing/completed/failed |
| latitude | FLOAT | 위도 |
| longitude | FLOAT | 경도 |
| created_at | TIMESTAMP | 생성 시간 |

---

## 기술 선택 이유

### Flutter (Mobile)

- **크로스 플랫폼**: iOS/Android 동시 개발
- **성능**: 네이티브 수준의 UI 렌더링
- **Dart**: 타입 안전성, 비동기 처리 용이

### FastAPI (Backend)

- **성능**: Starlette 기반 비동기 처리
- **자동 문서화**: OpenAPI/Swagger 자동 생성
- **타입 힌트**: Pydantic을 통한 검증

### PostgreSQL (Database)

- **JSONB**: 유연한 메타데이터 저장
- **확장성**: 대용량 데이터 처리
- **안정성**: ACID 보장

### Real-ESRGAN (AI)

- **품질**: 최신 Super Resolution 기술
- **속도**: GPU 가속 지원
- **범용성**: 다양한 이미지 타입 처리

### ESP32-CAM (Hardware)

- **저전력**: Deep Sleep으로 배터리 최적화
- **통합**: WiFi + BLE + Camera 단일 모듈
- **가격**: 저렴한 하드웨어 비용

---

## 배포 아키텍처

### 개발 환경

```
┌─────────────────────────────────────────┐
│            Docker Compose               │
│  ┌─────────┐     ┌─────────────────┐   │
│  │   App   │────►│   PostgreSQL    │   │
│  │ :8000   │     │   :5432         │   │
│  └─────────┘     └─────────────────┘   │
│       │                                 │
│       ▼                                 │
│  ┌─────────┐                            │
│  │ Storage │ (로컬 볼륨)                │
│  └─────────┘                            │
└─────────────────────────────────────────┘
```

### 프로덕션 환경 (AWS)

```
┌─────────────────────────────────────────────────────────────┐
│                         AWS VPC                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    Public Subnet                        │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │              Application Load Balancer            │  │ │
│  │  │              (HTTPS, ACM Certificate)             │  │ │
│  │  └───────────────────────┬──────────────────────────┘  │ │
│  └──────────────────────────┼─────────────────────────────┘ │
│                             │                                │
│  ┌──────────────────────────┼─────────────────────────────┐ │
│  │                  Private Subnet                         │ │
│  │                          │                              │ │
│  │  ┌───────────────────────┼───────────────────────────┐ │ │
│  │  │              ECS Cluster (Fargate)                 │ │ │
│  │  │  ┌─────────────┐     ┌─────────────┐              │ │ │
│  │  │  │  API Task   │     │ Worker Task │              │ │ │
│  │  │  │  (FastAPI)  │     │ (AI 처리)   │              │ │ │
│  │  │  └──────┬──────┘     └──────┬──────┘              │ │ │
│  │  └─────────┼───────────────────┼─────────────────────┘ │ │
│  │            │                   │                        │ │
│  │  ┌─────────▼───────────────────▼─────────────────────┐ │ │
│  │  │                RDS PostgreSQL                      │ │ │
│  │  │                (Multi-AZ)                          │ │ │
│  │  └────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────┐    ┌────────────────┐                   │
│  │   S3 Bucket    │    │   CloudWatch   │                   │
│  │  (이미지 저장)  │    │  (로그/메트릭) │                   │
│  └────────────────┘    └────────────────┘                   │
└──────────────────────────────────────────────────────────────┘
```

---

## 보안 고려사항

### 인증

- JWT (HS256) 기반 토큰 인증
- bcrypt 패스워드 해싱
- Rate Limiting (slowapi)

### 네트워크

- HTTPS (ACM 인증서)
- VPC Private Subnet
- Security Group 최소 권한

### 데이터

- .env 파일 gitignore
- 민감 정보 환경변수 관리
- DB 암호화 (RDS at-rest encryption)

---

## 확장 계획

### 단기

1. Refresh Token 구현
2. 소셜 로그인 (카카오)
3. Push Notification (FCM)

### 중기

1. 작업 큐 (Celery + Redis)
2. S3 이미지 저장
3. CDN 연동 (CloudFront)

### 장기

1. 실시간 스트리밍
2. 움직임 감지 이벤트 촬영
3. 다중 디바이스 지원
