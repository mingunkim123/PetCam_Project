# ì‘ì—… ë³´ê³ ì„œ #004: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

**ì‘ì—…ì¼**: 2026-01-27  
**ì‘ì—…ì**: í’€ìŠ¤íƒ ê°œë°œì  
**ì‘ì—… êµ¬ë¶„**: Week 2 (Day 11-14) - ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸

---

## ğŸ“‹ ìš”ì•½

ì´ë²ˆ ì‘ì—…ì—ì„œëŠ” **ì„œë²„ê°€ ì˜¬ë°”ë¥´ê²Œ ë™ì‘í•˜ëŠ”ì§€ ìë™ìœ¼ë¡œ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ**ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

ë§ˆì¹˜ **ìë™ì°¨ ì¶œê³  ì „ í’ˆì§ˆ ê²€ì‚¬**ì²˜ëŸ¼, ì½”ë“œê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ê²€ì‚¬í•˜ì—¬ ë¬¸ì œê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì•Œë ¤ì¤ë‹ˆë‹¤.

---

## ğŸ¤” í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ë­”ê°€ìš”?

### ë¹„ìœ ë¡œ ì„¤ëª…

**ë ˆìŠ¤í† ë‘ ì£¼ë°©**ì„ ìƒê°í•´ë³´ì„¸ìš”.

```
[í…ŒìŠ¤íŠ¸ ì—†ëŠ” ê°œë°œ]
ìš”ë¦¬ì‚¬ê°€ ìš”ë¦¬í•¨ â†’ ë°”ë¡œ ì†ë‹˜ì—ê²Œ ì œê³µ â†’ ì†ë‹˜: "ì´ê±° ì§œìš”!" ğŸ˜±

[í…ŒìŠ¤íŠ¸ ìˆëŠ” ê°œë°œ]
ìš”ë¦¬ì‚¬ê°€ ìš”ë¦¬í•¨ â†’ ë§› ê²€ì‚¬ â†’ ì—¼ë„ ê²€ì‚¬ â†’ ì˜¨ë„ ê²€ì‚¬ â†’ í†µê³¼í•˜ë©´ ì œê³µ
                    â†“
                ë¬¸ì œ ë°œê²¬ ì‹œ ë°”ë¡œ ìˆ˜ì •!
```

### í…ŒìŠ¤íŠ¸ì˜ ì¢…ë¥˜

| ì¢…ë¥˜ | ì„¤ëª… | ë¹„ìœ  |
|------|------|------|
| **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸** | í•¨ìˆ˜ í•˜ë‚˜í•˜ë‚˜ ê²€ì‚¬ | ì¬ë£Œ í•˜ë‚˜í•˜ë‚˜ ì‹ ì„ ë„ ê²€ì‚¬ |
| **í†µí•© í…ŒìŠ¤íŠ¸** | ì—¬ëŸ¬ ê¸°ëŠ¥ì´ í•¨ê»˜ ë™ì‘í•˜ëŠ”ì§€ | ìš”ë¦¬ ì™„ì„± í›„ ì „ì²´ ë§› ê²€ì‚¬ |
| **E2E í…ŒìŠ¤íŠ¸** | ì‚¬ìš©ì ì…ì¥ì—ì„œ ì „ì²´ íë¦„ | ì†ë‹˜ì´ ì‹¤ì œë¡œ ë¨¹ì–´ë³´ê¸° |

ì´ë²ˆì— ì‘ì„±í•œ ê²ƒì€ ì£¼ë¡œ **í†µí•© í…ŒìŠ¤íŠ¸**ì…ë‹ˆë‹¤.

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### ìƒì„±ëœ íŒŒì¼ 5ê°œ

```
ai_server/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py      # í…ŒìŠ¤íŠ¸ ì„¤ì • (ì¤€ë¹„ë¬¼)
â”‚   â”œâ”€â”€ test_health.py   # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸ (3ê°œ)
â”‚   â”œâ”€â”€ test_auth.py     # ì¸ì¦ í…ŒìŠ¤íŠ¸ (10ê°œ)
â”‚   â””â”€â”€ test_photos.py   # ì‚¬ì§„ API í…ŒìŠ¤íŠ¸ (9ê°œ)
â”œâ”€â”€ pytest.ini           # pytest ì„¤ì •
â””â”€â”€ requirements-test.txt # í…ŒìŠ¤íŠ¸ìš© íŒ¨í‚¤ì§€
```

### ì´ í…ŒìŠ¤íŠ¸ ê°œìˆ˜: 22ê°œ

| íŒŒì¼ | í…ŒìŠ¤íŠ¸ ìˆ˜ | ê²€ì‚¬ ë‚´ìš© |
|------|----------|----------|
| test_health.py | 3ê°œ | ì„œë²„ ìƒì¡´ í™•ì¸ |
| test_auth.py | 10ê°œ | íšŒì›ê°€ì…, ë¡œê·¸ì¸, í† í° |
| test_photos.py | 9ê°œ | ì‚¬ì§„ ì—…ë¡œë“œ, ì¡°íšŒ, ì‚­ì œ |

---

## ğŸ“„ íŒŒì¼ 1: conftest.py (í…ŒìŠ¤íŠ¸ ì„¤ì •)

### ì´ íŒŒì¼ì´ í•˜ëŠ” ì¼

```
í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ì— í•„ìš”í•œ ì¤€ë¹„ë¬¼ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

[ì¤€ë¹„ë¬¼ ëª©ë¡]
1. í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ë°ì´í„°ë² ì´ìŠ¤ (ì‹¤ì œ DB ì•ˆ ê±´ë“œë¦¼)
2. API ìš”ì²­ ë³´ë‚´ëŠ” ë„êµ¬
3. í…ŒìŠ¤íŠ¸ìš© ì‚¬ìš©ì ê³„ì •
4. í…ŒìŠ¤íŠ¸ìš© ë¡œê·¸ì¸ í† í°
```

### ì „ì²´ ì½”ë“œ (ì£¼ì„ í¬í•¨)

```python
"""
=============================================================================
PetCam AI Server - í…ŒìŠ¤íŠ¸ ì„¤ì • íŒŒì¼ (conftest.py)
=============================================================================

ì´ íŒŒì¼ì´ í•˜ëŠ” ì¼:
    í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— í•„ìš”í•œ ì¤€ë¹„ë¬¼ë“¤ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
    ë§ˆì¹˜ ìš”ë¦¬í•˜ê¸° ì „ì— ì¬ë£Œë¥¼ ì¤€ë¹„í•˜ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.

ì£¼ìš” êµ¬ì„±ìš”ì†Œ:
    1. í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë² ì´ìŠ¤ (ì‹¤ì œ DBë¥¼ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
    2. í…ŒìŠ¤íŠ¸ìš© API í´ë¼ì´ì–¸íŠ¸ (ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ë„êµ¬)
    3. í…ŒìŠ¤íŠ¸ìš© ì‚¬ìš©ì ê³„ì • (ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©)

ì‚¬ìš© ë°©ë²•:
    pytest tests/ -v
=============================================================================
"""

import os
import asyncio
from typing import AsyncGenerator, Generator

import pytest
import pytest_asyncio
from httpx import AsyncClient, ASGITransport
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool

# =============================================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)
# =============================================================================
# í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ê¸° ì „ì— í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
# ì´ë ‡ê²Œ í•˜ë©´ ì‹¤ì œ ì„œë²„ ì„¤ì •ê³¼ ì¶©ëŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

os.environ["SECRET_KEY"] = "test-secret-key-for-testing-only-do-not-use-in-production"
os.environ["DATABASE_URL"] = "sqlite+aiosqlite:///:memory:"  # ë©”ëª¨ë¦¬ DB (í…ŒìŠ¤íŠ¸ìš©)
os.environ["ALLOWED_ORIGINS"] = "*"


# =============================================================================
# ì´ì œ ì•±ì„ ì„í¬íŠ¸í•©ë‹ˆë‹¤ (í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í›„!)
# =============================================================================
from database import Base
from main import app
from app.auth import get_password_hash, create_access_token
from app.models.user import User


# =============================================================================
# í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ ìƒì„±
# =============================================================================
# SQLite ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
# - ì¥ì : ë¹ ë¥´ê³ , í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§
# - ì‹¤ì œ PostgreSQLê³¼ 100% ë™ì¼í•˜ì§€ëŠ” ì•Šì§€ë§Œ, ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ì—ëŠ” ì¶©ë¶„

test_engine = create_async_engine(
    "sqlite+aiosqlite:///:memory:",  # ë©”ëª¨ë¦¬ì—ë§Œ ì¡´ì¬í•˜ëŠ” ì„ì‹œ DB
    connect_args={"check_same_thread": False},  # SQLite ë©€í‹°ìŠ¤ë ˆë“œ í—ˆìš©
    poolclass=StaticPool,  # ì—°ê²° í’€ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)
)

# í…ŒìŠ¤íŠ¸ìš© ì„¸ì…˜ íŒ©í† ë¦¬
TestSessionLocal = sessionmaker(
    bind=test_engine,
    class_=AsyncSession,
    autocommit=False,
    autoflush=False,
    expire_on_commit=False,
)


# =============================================================================
# Fixture: ì´ë²¤íŠ¸ ë£¨í”„ ì„¤ì •
# =============================================================================
# pytest-asyncioê°€ ë¹„ë™ê¸° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

@pytest.fixture(scope="session")
def event_loop() -> Generator:
    """
    í…ŒìŠ¤íŠ¸ ì„¸ì…˜ ì „ì²´ì—ì„œ ì‚¬ìš©í•  ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    ë¹„ìœ : 
        í…ŒìŠ¤íŠ¸ë“¤ì´ ë‹¬ë¦´ ìˆ˜ ìˆëŠ” 'ìš´ë™ì¥'ì„ ë§Œë“œëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.
        ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ê°™ì€ ìš´ë™ì¥ì—ì„œ ë›°ì–´ì•¼ ì¶©ëŒì´ ì—†ìŠµë‹ˆë‹¤.
    """
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop  # í…ŒìŠ¤íŠ¸ê°€ ëë‚  ë•Œê¹Œì§€ ì´ ë£¨í”„ë¥¼ ì‚¬ìš©
    loop.close()  # í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ì •ë¦¬


# =============================================================================
# Fixture: í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜
# =============================================================================

@pytest_asyncio.fixture
async def db_session() -> AsyncGenerator[AsyncSession, None]:
    """
    ê° í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ìƒˆë¡œìš´ ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.
    
    ë™ì‘ ë°©ì‹:
        1. í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „: í…Œì´ë¸” ìƒì„±
        2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰: DB ì„¸ì…˜ ì‚¬ìš©
        3. í…ŒìŠ¤íŠ¸ ì¢…ë£Œ í›„: í…Œì´ë¸” ì‚­ì œ (ê¹¨ë—í•˜ê²Œ ì •ë¦¬)
    
    ë¹„ìœ :
        ì‹œí—˜ ë³¼ ë•Œë§ˆë‹¤ ìƒˆ ì‹œí—˜ì§€ë¥¼ ë°›ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.
        ì´ì „ í•™ìƒì˜ ë‹µì´ ë‚¨ì•„ìˆìœ¼ë©´ ì•ˆ ë˜ë‹ˆê¹Œìš”!
    """
    # 1. í…Œì´ë¸” ìƒì„± (CREATE TABLE)
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    # 2. ì„¸ì…˜ ìƒì„± ë° í…ŒìŠ¤íŠ¸ì— ì œê³µ
    async with TestSessionLocal() as session:
        yield session  # ì´ ì„¸ì…˜ì„ í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©
    
    # 3. í…Œì´ë¸” ì‚­ì œ (DROP TABLE) - ê¹¨ë—í•˜ê²Œ ì •ë¦¬
    async with test_engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)


# =============================================================================
# Fixture: í…ŒìŠ¤íŠ¸ìš© API í´ë¼ì´ì–¸íŠ¸
# =============================================================================

@pytest_asyncio.fixture
async def client(db_session: AsyncSession) -> AsyncGenerator[AsyncClient, None]:
    """
    API ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆëŠ” í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    ì´ê²Œ ë­”ê°€ìš”?
        ì‹¤ì œë¡œ ì„œë²„ë¥¼ ë„ìš°ì§€ ì•Šê³ ë„ APIë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.
        ë§ˆì¹˜ ë¹„í–‰ ì‹œë®¬ë ˆì´í„°ì²˜ëŸ¼, ì§„ì§œ ë¹„í–‰ê¸°ë¥¼ ë„ìš°ì§€ ì•Šê³  ì¡°ì¢… ì—°ìŠµì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    ì‚¬ìš© ì˜ˆì‹œ:
        response = await client.get("/health")
        response = await client.post("/register", json={"username": "test"})
    """
    
    # í…ŒìŠ¤íŠ¸ìš© DB ì„¸ì…˜ì„ ì•±ì— ì£¼ì…í•˜ëŠ” í•¨ìˆ˜
    async def override_get_db():
        yield db_session
    
    # ì›ë˜ DB ëŒ€ì‹  í…ŒìŠ¤íŠ¸ DBë¥¼ ì‚¬ìš©í•˜ë„ë¡ êµì²´
    from app.auth import get_db
    app.dependency_overrides[get_db] = override_get_db
    
    # í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    async with AsyncClient(
        transport=ASGITransport(app=app),  # FastAPI ì•±ì— ì§ì ‘ ì—°ê²°
        base_url="http://test"  # í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ URL
    ) as ac:
        yield ac  # ì´ í´ë¼ì´ì–¸íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©
    
    # í…ŒìŠ¤íŠ¸ í›„ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
    app.dependency_overrides.clear()


# =============================================================================
# Fixture: í…ŒìŠ¤íŠ¸ìš© ì‚¬ìš©ì ìƒì„±
# =============================================================================

@pytest_asyncio.fixture
async def test_user(db_session: AsyncSession) -> User:
    """
    í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  ì‚¬ìš©ì ê³„ì •ì„ ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘¡ë‹ˆë‹¤.
    
    ìƒì„±ë˜ëŠ” ê³„ì •:
        - ì•„ì´ë””: testuser
        - ë¹„ë°€ë²ˆí˜¸: testpassword123
    
    ì™œ í•„ìš”í•œê°€ìš”?
        ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸, ì¸ì¦ì´ í•„ìš”í•œ API í…ŒìŠ¤íŠ¸ ë“±ì—ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        ë§¤ë²ˆ íšŒì›ê°€ì…ë¶€í„° í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ëŠë ¤ì§€ê³  ë³µì¡í•´ì§€ë‹ˆê¹Œìš”.
    """
    # ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸í™”í•´ì„œ ì €ì¥ (ì‹¤ì œ ì„œë¹„ìŠ¤ì™€ ë™ì¼í•œ ë°©ì‹)
    hashed_password = get_password_hash("testpassword123")
    
    # ì‚¬ìš©ì ìƒì„±
    user = User(
        username="testuser",
        hashed_password=hashed_password,
        is_active=True  # í™œì„± ìƒíƒœ
    )
    
    # DBì— ì €ì¥
    db_session.add(user)
    await db_session.commit()
    await db_session.refresh(user)  # DBì—ì„œ ìƒì„±ëœ ID ë“±ì„ ê°€ì ¸ì˜´
    
    return user


# =============================================================================
# Fixture: í…ŒìŠ¤íŠ¸ìš© ì¸ì¦ í† í°
# =============================================================================

@pytest_asyncio.fixture
async def auth_token(test_user: User) -> str:
    """
    í…ŒìŠ¤íŠ¸ìš© JWT ì¸ì¦ í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    ì´ê²Œ ë­”ê°€ìš”?
        ë¡œê·¸ì¸í•˜ë©´ ë°›ëŠ” 'ì¶œì…ì¦' ê°™ì€ ê²ƒì…ë‹ˆë‹¤.
        ì´ í† í°ì´ ìˆì–´ì•¼ ì‚¬ì§„ ì—…ë¡œë“œ ê°™ì€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    ì‚¬ìš© ì˜ˆì‹œ:
        headers = {"Authorization": f"Bearer {auth_token}"}
        response = await client.get("/photos", headers=headers)
    """
    # JWT í† í° ìƒì„± (ì‹¤ì œ ë¡œê·¸ì¸ê³¼ ë™ì¼í•œ ë°©ì‹)
    token = create_access_token(data={"sub": test_user.username})
    return token


# =============================================================================
# Fixture: ì¸ì¦ëœ í´ë¼ì´ì–¸íŠ¸ (í† í° í¬í•¨)
# =============================================================================

@pytest_asyncio.fixture
async def authenticated_client(
    client: AsyncClient, 
    auth_token: str
) -> AsyncClient:
    """
    ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœì˜ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    
    ì™œ í•„ìš”í•œê°€ìš”?
        ì¸ì¦ì´ í•„ìš”í•œ APIë¥¼ í…ŒìŠ¤íŠ¸í•  ë•Œë§ˆë‹¤ 
        headers={"Authorization": ...}ë¥¼ ì“°ê¸° ê·€ì°®ìœ¼ë‹ˆê¹Œìš”!
    
    ì‚¬ìš© ì˜ˆì‹œ:
        # í† í° ì—†ì´ë„ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥!
        response = await authenticated_client.get("/photos")
    """
    # ëª¨ë“  ìš”ì²­ì— ì¸ì¦ í—¤ë” ìë™ ì¶”ê°€
    client.headers["Authorization"] = f"Bearer {auth_token}"
    return client
```

### ì½”ë“œ ì„¤ëª… (ë¹„ì „ê³µììš©)

| ìš©ì–´ | ì˜ë¯¸ |
|------|------|
| `fixture` | í…ŒìŠ¤íŠ¸ ì „ì— ì¤€ë¹„í•´ë‘ëŠ” ê²ƒ (ì¤€ë¹„ë¬¼) |
| `@pytest_asyncio.fixture` | "ì´ê±´ ì¤€ë¹„ë¬¼ì´ì•¼" í‘œì‹œ |
| `yield` | "ì—¬ê¸°ê¹Œì§€ ì¤€ë¹„, ì—¬ê¸°ì„œë¶€í„° ì •ë¦¬" |
| `AsyncClient` | API ìš”ì²­ ë³´ë‚´ëŠ” ë„êµ¬ |
| `db_session` | ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° |

---

## ğŸ“„ íŒŒì¼ 2: test_health.py (í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸)

### í…ŒìŠ¤íŠ¸ ëª©ë¡ (3ê°œ)

| ë²ˆí˜¸ | í…ŒìŠ¤íŠ¸ëª… | í™•ì¸ ë‚´ìš© |
|------|---------|----------|
| 1 | test_health_check_returns_ok | ì„œë²„ê°€ "ok" ì‘ë‹µ ë°˜í™˜ |
| 2 | test_health_check_includes_version | ë²„ì „ ì •ë³´ í¬í•¨ ì—¬ë¶€ |
| 3 | test_health_check_response_time | 1ì´ˆ ì´ë‚´ ì‘ë‹µ ì—¬ë¶€ |

### ì£¼ìš” í…ŒìŠ¤íŠ¸ ì½”ë“œ

```python
@pytest.mark.asyncio  # ì´ í…ŒìŠ¤íŠ¸ëŠ” ë¹„ë™ê¸°ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
async def test_health_check_returns_ok(client: AsyncClient):
    """
    í—¬ìŠ¤ì²´í¬ APIê°€ ì •ìƒ ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    
    í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:
        1. GET /health ìš”ì²­ì„ ë³´ëƒ„
        2. ìƒíƒœ ì½”ë“œê°€ 200(ì„±ê³µ)ì¸ì§€ í™•ì¸
        3. ì‘ë‹µì— "status": "ok"ê°€ ìˆëŠ”ì§€ í™•ì¸
    
    ê¸°ëŒ€ ê²°ê³¼:
        {
            "status": "ok",
            "version": "1.0.0"
        }
    """
    # =====================
    # 1ë‹¨ê³„: API ìš”ì²­ ë³´ë‚´ê¸°
    # =====================
    response = await client.get("/health")
    
    # =====================
    # 2ë‹¨ê³„: ìƒíƒœ ì½”ë“œ í™•ì¸
    # =====================
    # 200 = ìš”ì²­ ì„±ê³µ
    # ë§Œì•½ 404ë©´ "í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
    # ë§Œì•½ 500ì´ë©´ "ì„œë²„ ì˜¤ë¥˜"
    assert response.status_code == 200, \
        f"ì˜ˆìƒ: 200, ì‹¤ì œ: {response.status_code}"
    
    # =====================
    # 3ë‹¨ê³„: ì‘ë‹µ ë‚´ìš© í™•ì¸
    # =====================
    data = response.json()  # JSON ì‘ë‹µì„ íŒŒì´ì¬ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
    
    # "status" í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
    assert "status" in data, \
        "ì‘ë‹µì— 'status' í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤"
    
    # "status"ê°€ "ok"ì¸ì§€ í™•ì¸
    assert data["status"] == "ok", \
        f"ì˜ˆìƒ: 'ok', ì‹¤ì œ: '{data['status']}'"
```

### ì½”ë“œ ì„¤ëª…

| ì½”ë“œ | ì˜ë¯¸ |
|------|------|
| `@pytest.mark.asyncio` | "ì´ í…ŒìŠ¤íŠ¸ëŠ” ë¹„ë™ê¸°ì•¼" |
| `await client.get("/health")` | "/health ì£¼ì†Œë¡œ ìš”ì²­ ë³´ë‚´" |
| `response.status_code` | ì‘ë‹µ ìƒíƒœ ì½”ë“œ (200=ì„±ê³µ) |
| `response.json()` | ì‘ë‹µì„ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜ |
| `assert A == B` | "Aê°€ Bì™€ ê°™ì•„ì•¼ í•´, ì•„ë‹ˆë©´ ì‹¤íŒ¨!" |

---

## ğŸ“„ íŒŒì¼ 3: test_auth.py (ì¸ì¦ í…ŒìŠ¤íŠ¸)

### í…ŒìŠ¤íŠ¸ ëª©ë¡ (10ê°œ)

#### íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸ (4ê°œ)

| ë²ˆí˜¸ | í…ŒìŠ¤íŠ¸ëª… | í™•ì¸ ë‚´ìš© |
|------|---------|----------|
| 1 | test_register_success | ì •ìƒ íšŒì›ê°€ì… |
| 2 | test_register_duplicate_username | ì¤‘ë³µ ì•„ì´ë”” ê±°ë¶€ |
| 3 | test_register_username_too_short | ì§§ì€ ì•„ì´ë”” ê±°ë¶€ |
| 4 | test_register_password_too_short | ì§§ì€ ë¹„ë°€ë²ˆí˜¸ ê±°ë¶€ |

#### ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ (6ê°œ)

| ë²ˆí˜¸ | í…ŒìŠ¤íŠ¸ëª… | í™•ì¸ ë‚´ìš© |
|------|---------|----------|
| 5 | test_login_success | ì •ìƒ ë¡œê·¸ì¸ |
| 6 | test_login_wrong_password | í‹€ë¦° ë¹„ë°€ë²ˆí˜¸ ê±°ë¶€ |
| 7 | test_login_nonexistent_user | ì—†ëŠ” ì‚¬ìš©ì ê±°ë¶€ |
| 8 | test_authenticated_request | í† í°ìœ¼ë¡œ ì¸ì¦ ì„±ê³µ |
| 9 | test_unauthenticated_request | í† í° ì—†ì´ ì ‘ê·¼ ê±°ë¶€ |
| 10 | test_invalid_token | ê°€ì§œ í† í° ê±°ë¶€ |

### í•µì‹¬ í…ŒìŠ¤íŠ¸ ì½”ë“œ

```python
@pytest.mark.asyncio
async def test_register_success(self, client: AsyncClient):
    """
    ì •ìƒì ì¸ íšŒì›ê°€ì…ì´ ì„±ê³µí•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    """
    # =====================
    # 1ë‹¨ê³„: íšŒì›ê°€ì… ìš”ì²­
    # =====================
    # ìƒˆë¡œìš´ ì‚¬ìš©ì ì •ë³´
    new_user = {
        "username": "newuser",      # ì•„ì´ë”” (3ì ì´ìƒ)
        "password": "securepass123"  # ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)
    }
    
    # POST ìš”ì²­ ë³´ë‚´ê¸°
    response = await client.post(
        "/register",           # ìš”ì²­í•  ì£¼ì†Œ
        json=new_user          # ë³´ë‚¼ ë°ì´í„° (JSON í˜•ì‹)
    )
    
    # =====================
    # 2ë‹¨ê³„: ì‘ë‹µ í™•ì¸
    # =====================
    # 200 = ì„±ê³µ
    assert response.status_code == 200, \
        f"íšŒì›ê°€ì… ì‹¤íŒ¨: {response.status_code} - {response.text}"
    
    # =====================
    # 3ë‹¨ê³„: ì‘ë‹µ ë°ì´í„° í™•ì¸
    # =====================
    data = response.json()
    
    # ì•„ì´ë””ê°€ ì‘ë‹µì— ìˆëŠ”ì§€ í™•ì¸
    assert data["username"] == "newuser", \
        "ì‘ë‹µì˜ usernameì´ ìš”ì²­ê³¼ ë‹¤ë¦…ë‹ˆë‹¤"
    
    # ì‚¬ìš©ì IDê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
    assert "id" in data, \
        "ì‘ë‹µì— ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤"


@pytest.mark.asyncio
async def test_login_success(self, client: AsyncClient, test_user):
    """
    ì˜¬ë°”ë¥¸ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ì´ ì„±ê³µí•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    """
    # OAuth2 í‘œì¤€ í˜•ì‹ (form ë°ì´í„°)
    login_data = {
        "username": "testuser",       # í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ì•„ì´ë””
        "password": "testpassword123"  # í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸
    }
    
    # POST ìš”ì²­ (form í˜•ì‹)
    response = await client.post(
        "/token",
        data=login_data  # jsonì´ ì•„ë‹ˆë¼ data! (OAuth2 í‘œì¤€)
    )
    
    # ìƒíƒœ ì½”ë“œ í™•ì¸
    assert response.status_code == 200
    
    # í† í° í™•ì¸
    data = response.json()
    assert "access_token" in data  # í† í°ì´ ìˆì–´ì•¼ í•¨
    assert data["token_type"] == "bearer"  # íƒ€ì…ì€ bearer


@pytest.mark.asyncio
async def test_login_wrong_password(self, client: AsyncClient, test_user):
    """
    ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ë©´ ê±°ë¶€ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    
    ì™œ ì¤‘ìš”í•œê°€ìš”?
        ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¤ë„ ë¡œê·¸ì¸ë˜ë©´ ë³´ì•ˆ ì‚¬ê³ ì…ë‹ˆë‹¤!
    """
    wrong_login = {
        "username": "testuser",
        "password": "wrongpassword"  # í‹€ë¦° ë¹„ë°€ë²ˆí˜¸!
    }
    
    response = await client.post("/token", data=wrong_login)
    
    # 401 = ì¸ì¦ ì‹¤íŒ¨
    assert response.status_code == 401, \
        "ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹¬ê°í•œ ë³´ì•ˆ ë¬¸ì œ!)"
```

---

## ğŸ“„ íŒŒì¼ 4: test_photos.py (ì‚¬ì§„ API í…ŒìŠ¤íŠ¸)

### í…ŒìŠ¤íŠ¸ ëª©ë¡ (9ê°œ)

| ë²ˆí˜¸ | í…ŒìŠ¤íŠ¸ëª… | í™•ì¸ ë‚´ìš© |
|------|---------|----------|
| 1 | test_get_photos_empty | ë¹ˆ ëª©ë¡ ë°˜í™˜ |
| 2 | test_get_photos_without_auth | ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê±°ë¶€ |
| 3 | test_get_photos_with_skip | skip íŒŒë¼ë¯¸í„° ë™ì‘ |
| 4 | test_get_photos_with_limit | limit íŒŒë¼ë¯¸í„° ë™ì‘ |
| 5 | test_get_photos_invalid_skip | ìŒìˆ˜ skip ê±°ë¶€ |
| 6 | test_get_photos_limit_exceeded | limit ìµœëŒ€ê°’ ì´ˆê³¼ ê±°ë¶€ |
| 7 | test_upload_without_auth | ì¸ì¦ ì—†ì´ ì—…ë¡œë“œ ê±°ë¶€ |
| 8 | test_delete_nonexistent_photo | ì—†ëŠ” ì‚¬ì§„ ì‚­ì œ 404 |
| 9 | test_get_nonexistent_photo | ì—†ëŠ” ì‚¬ì§„ ì¡°íšŒ 404 |

### í•µì‹¬ í…ŒìŠ¤íŠ¸ ì½”ë“œ

```python
@pytest.mark.asyncio
async def test_get_photos_empty(self, authenticated_client: AsyncClient):
    """
    ì‚¬ì§„ì´ ì—†ì„ ë•Œ ë¹ˆ ëª©ë¡ì„ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    """
    # API ìš”ì²­ (ì´ë¯¸ ì¸ì¦ëœ í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©)
    response = await authenticated_client.get("/photos")
    
    # ìƒíƒœ ì½”ë“œ í™•ì¸
    assert response.status_code == 200
    
    # ì‘ë‹µ ë°ì´í„° í™•ì¸
    data = response.json()
    
    # ë¦¬ìŠ¤íŠ¸ í˜•íƒœì¸ì§€ í™•ì¸
    assert isinstance(data, list), \
        f"ì‘ë‹µì´ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹™ë‹ˆë‹¤: {type(data)}"
    
    # ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸ (ì•„ì§ ì—…ë¡œë“œí•œ ì‚¬ì§„ ì—†ìŒ)
    assert len(data) == 0


@pytest.mark.asyncio
async def test_get_photos_without_auth(self, client: AsyncClient):
    """
    ì¸ì¦ ì—†ì´ ì‚¬ì§„ ëª©ë¡ì„ ìš”ì²­í•˜ë©´ ê±°ë¶€ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    
    ì™œ ì¤‘ìš”í•œê°€ìš”?
        ë‹¤ë¥¸ ì‚¬ëŒì˜ ì‚¬ì§„ì„ ì•„ë¬´ë‚˜ ë³¼ ìˆ˜ ìˆìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤!
    """
    # ì¸ì¦ ì—†ì´ ìš”ì²­ (ì¼ë°˜ client ì‚¬ìš©)
    response = await client.get("/photos")
    
    # 401 = ì¸ì¦ í•„ìš”
    assert response.status_code == 401, \
        "ì¸ì¦ ì—†ì´ ì‚¬ì§„ ëª©ë¡ì— ì ‘ê·¼ì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤"
```

---

## ğŸ“„ íŒŒì¼ 5: pytest.ini (ì„¤ì • íŒŒì¼)

```ini
# =============================================================================
# PetCam AI Server - pytest ì„¤ì • íŒŒì¼
# =============================================================================

[pytest]

# ë¹„ë™ê¸° í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì„¤ì •
asyncio_mode = auto

# ê¸°ë³¸ ì‹¤í–‰ ì˜µì…˜
# -v          : ìì„¸í•œ ì¶œë ¥
# --tb=short  : ê°„ë‹¨í•œ ì—ëŸ¬ ë©”ì‹œì§€
# -ra         : í…ŒìŠ¤íŠ¸ ìš”ì•½ ì¶œë ¥
addopts = -v --tb=short -ra

# í…ŒìŠ¤íŠ¸ íŒŒì¼ ì°¾ê¸° ê·œì¹™
python_files = test_*.py *_test.py
python_functions = test_*
python_classes = Test*

# í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬
testpaths = tests
```

---

## ğŸ“„ íŒŒì¼ 6: requirements-test.txt (í…ŒìŠ¤íŠ¸ íŒ¨í‚¤ì§€)

```text
# í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬
pytest>=7.4.0

# ë¹„ë™ê¸° í…ŒìŠ¤íŠ¸ ì§€ì›
pytest-asyncio>=0.21.0

# í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
pytest-cov>=4.1.0

# ë¹„ë™ê¸° HTTP í´ë¼ì´ì–¸íŠ¸
httpx>=0.25.0

# í…ŒìŠ¤íŠ¸ìš© SQLite
aiosqlite>=0.19.0

# ì½”ë“œ ë¦°í„°
ruff>=0.1.0
```

---

## ğŸ”„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•

### ë¡œì»¬ì—ì„œ ì‹¤í–‰

```bash
# 1. í…ŒìŠ¤íŠ¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
cd ai_server
pip install -r requirements-test.txt

# 2. ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
pytest

# 3. íŠ¹ì • íŒŒì¼ë§Œ ì‹¤í–‰
pytest tests/test_auth.py

# 4. ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
pytest --cov=app --cov-report=html
```

### CI/CDì—ì„œ ìë™ ì‹¤í–‰

```
ì½”ë“œ í‘¸ì‹œ â†’ GitHub Actions ì‹¤í–‰ â†’ í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰ â†’ ê²°ê³¼ ì•Œë¦¼
```

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì˜ˆì‹œ

```
==================== test session starts ====================
platform linux -- Python 3.10.0, pytest-7.4.0
rootdir: /app/ai_server
configfile: pytest.ini
plugins: asyncio-0.21.0, cov-4.1.0

tests/test_health.py
    âœ… test_health_check_returns_ok PASSED
    âœ… test_health_check_includes_version PASSED
    âœ… test_health_check_response_time PASSED

tests/test_auth.py
    âœ… test_register_success PASSED
    âœ… test_register_duplicate_username PASSED
    âœ… test_register_username_too_short PASSED
    âœ… test_register_password_too_short PASSED
    âœ… test_login_success PASSED
    âœ… test_login_wrong_password PASSED
    ...

==================== 22 passed in 3.45s ====================
```

---

## ğŸ¯ ì´ ì‘ì—…ìœ¼ë¡œ ì–»ëŠ” íš¨ê³¼

### Before (í…ŒìŠ¤íŠ¸ ì—†ìŒ)

```
ê°œë°œì: ê¸°ëŠ¥ ìˆ˜ì • ì™„ë£Œ!
ê°œë°œì: (ëŒ€ì¶© í™•ì¸) ì˜ ë˜ëŠ” ê²ƒ ê°™ë„¤
ê°œë°œì: ë°°í¬!
...3ì¼ í›„...
ì‚¬ìš©ì: ë¡œê·¸ì¸ì´ ì•ˆ ë¼ìš” ğŸ˜±
ê°œë°œì: ì—¥? ê·¸ ê¸°ëŠ¥ ì•ˆ ê±´ë“œë ¸ëŠ”ë°...
```

### After (í…ŒìŠ¤íŠ¸ ìˆìŒ)

```
ê°œë°œì: ê¸°ëŠ¥ ìˆ˜ì • ì™„ë£Œ!
CI: ğŸ” 22ê°œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...
CI: âŒ test_login_success ì‹¤íŒ¨!
CI: "ë¡œê·¸ì¸ ë¡œì§ì´ ê¹¨ì¡ŒìŠµë‹ˆë‹¤"
ê°œë°œì: ì•„ì°¨! ìˆ˜ì •í•˜ê³  ë‹¤ì‹œ í‘¸ì‹œí•´ì•¼ê² ë‹¤
```

---

## ğŸ“ ìƒì„±ëœ íŒŒì¼ ìš”ì•½

| íŒŒì¼ | ìš©ë„ | ì¤„ ìˆ˜ |
|------|------|------|
| `tests/conftest.py` | í…ŒìŠ¤íŠ¸ ì„¤ì • | ~180ì¤„ |
| `tests/test_health.py` | í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸ | ~80ì¤„ |
| `tests/test_auth.py` | ì¸ì¦ í…ŒìŠ¤íŠ¸ | ~220ì¤„ |
| `tests/test_photos.py` | ì‚¬ì§„ API í…ŒìŠ¤íŠ¸ | ~180ì¤„ |
| `pytest.ini` | pytest ì„¤ì • | ~40ì¤„ |
| `requirements-test.txt` | í…ŒìŠ¤íŠ¸ íŒ¨í‚¤ì§€ | ~30ì¤„ |

**ì´ ì•½ 730ì¤„ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±**

---

## âœ… ì§„í–‰ í˜„í™© ì—…ë°ì´íŠ¸

| ì‘ì—… | ìƒíƒœ |
|------|------|
| Week 1: ë¬¸ì„œí™” | âœ… ì™„ë£Œ |
| Week 1: í”„ë¡œë•ì…˜ í™˜ê²½ | âœ… ì™„ë£Œ |
| Week 1: AWS ì¸í”„ë¼ | â­ï¸ ìŠ¤í‚µ |
| Week 2: CI/CD | âœ… ì™„ë£Œ |
| **Week 2: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸** | **âœ… ì™„ë£Œ** |
| Week 3: ì¸ì¦ ê°•í™” | â³ ëŒ€ê¸° |

---

## ë‹¤ìŒ ë‹¨ê³„

**Week 3 (Day 15-17): ì¸ì¦ ì‹œìŠ¤í…œ ê°•í™”**
- Refresh Token êµ¬í˜„
- ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸ ì¶”ê°€

---

*ë³´ê³ ì„œ ì‘ì„±ì¼: 2026-01-27*  
*ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”!*
